// =====================
// 初期設定
// =====================
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

canvas.width = 800;
canvas.height = 600;

// =====================
// 難易度設定
// =====================
const difficultySettings = {
    easy: { name: 'EASY', invaderBaseSpeed: 0.5, invaderSpeedIncrease: 0.1 },
    normal: { name: 'NORMAL', invaderBaseSpeed: 1, invaderSpeedIncrease: 0.2 },
    hard: { name: 'HARD', invaderBaseSpeed: 1.5, invaderSpeedIncrease: 0.3 }
};

// =====================
// ゲーム状態
// =====================
const gameState = {
    difficulty: 'normal',
    score: 0,
    wave: 1,
    gameOver: false,

    player: {
        x: 370,
        y: 540,
        width: 60,
        height: 20,
        speed: 6,
        health: 100,
        maxHealth: 100,
        shield: false,
        weapon: 'normal'
    },

    bullets: [],
    invaderBullets: [],
    invaders: [],
    powerUps: [],
    particles: [],
    stars: [],
    invaderDirection: 1,
    invaderSpeed: 1
};

// =====================
// 初期生成
// =====================
function createStars() {
    gameState.stars = [];
    for (let i = 0; i < 100; i++) {
        gameState.stars.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            size: Math.random() * 2 + 1
        });
    }
}

function createInvaders() {
    gameState.invaders = [];
    const rows = 4;
    const cols = 10;

    for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
            gameState.invaders.push({
                x: 80 + c * 60,
                y: 50 + r * 50,
                width: 40,
                height: 30,
                alive: true,
                type: r % 3
            });
        }
    }
}

function startGame(diff) {
    gameState.difficulty = diff;
    gameState.score = 0;
    gameState.wave = 1;
    gameState.gameOver = false;
    gameState.player.health = gameState.player.maxHealth;
    gameState.player.weapon = 'normal';
    gameState.player.shield = false;

    const settings = difficultySettings[diff];
    gameState.invaderSpeed = settings.invaderBaseSpeed;

    gameState.bullets = [];
    gameState.invaderBullets = [];
    gameState.powerUps = [];
    gameState.particles = [];

    createStars();
    createInvaders();
    updateUI();
}

// =====================
// 入力
// =====================
const keys = {};
window.addEventListener('keydown', e => keys[e.key] = true);
window.addEventListener('keyup', e => keys[e.key] = false);

// =====================
// パワーアップ
// =====================
function spawnPowerUp(x, y) {
    const types = ['health', 'shield', 'triple', 'laser'];
    gameState.powerUps.push({
        x, y,
        width: 20,
        height: 20,
        type: types[Math.floor(Math.random() * types.length)],
        speed: 2
    });
}

// =====================
// 更新処理
// =====================
function update() {
    if (gameState.gameOver) return;

    // プレイヤー移動
    if (keys['ArrowLeft']) gameState.player.x -= gameState.player.speed;
    if (keys['ArrowRight']) gameState.player.x += gameState.player.speed;

    gameState.player.x = Math.max(
        0,
        Math.min(canvas.width - gameState.player.width, gameState.player.x)
    );

    // 弾更新
    gameState.bullets = gameState.bullets.filter(b => {
        b.y -= b.speed;
        return b.y > 0;
    });

    gameState.invaderBullets = gameState.invaderBullets.filter(b => {
        b.y += b.speed;
        return b.y < canvas.height;
    });

    // インベーダー移動
    let edgeHit = false;
    gameState.invaders.forEach(inv => {
        if (!inv.alive) return;
        inv.x += gameState.invaderSpeed * gameState.invaderDirection;
        if (inv.x <= 0 || inv.x + inv.width >= canvas.width) {
            edgeHit = true;
        }
    });

    if (edgeHit) {
        gameState.invaderDirection *= -1;
        gameState.invaders.forEach(inv => inv.y += 20);
    }

    // 衝突判定
    gameState.bullets.forEach(bullet => {
        gameState.invaders.forEach(invader => {
            if (!invader.alive) return;

            if (
                bullet.x < invader.x + invader.width &&
                bullet.x + bullet.width > invader.x &&
                bullet.y < invader.y + invader.height &&
                bullet.y + bullet.height > invader.y
            ) {
                invader.alive = false;
                bullet.y = -100;
                gameState.score += 10;

                if (Math.random() < 0.2) {
                    spawnPowerUp(
                        invader.x + invader.width / 2,
                        invader.y + invader.height / 2
                    );
                }
            }
        });
    });

    // ウェーブクリア
    if (gameState.invaders.every(i => !i.alive)) {
        gameState.wave++;
        gameState.score += gameState.wave * 100;

        const s = difficultySettings[gameState.difficulty];
        gameState.invaderSpeed =
            s.invaderBaseSpeed + gameState.wave * s.invaderSpeedIncrease;

        createInvaders();
        updateUI();
    }
}

// =====================
// 描画
// =====================
function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // 星
    ctx.fillStyle = '#fff';
    gameState.stars.forEach(s => ctx.fillRect(s.x, s.y, s.size, s.size));

    // プレイヤー
    ctx.fillStyle = gameState.player.shield ? '#0ff' : '#0f0';
    ctx.fillRect(
        gameState.player.x,
        gameState.player.y,
        gameState.player.width,
        gameState.player.height
    );

    // 弾
    ctx.fillStyle = '#0ff';
    gameState.bullets.forEach(b =>
        ctx.fillRect(b.x, b.y, b.width, b.height)
    );

    // 敵
    gameState.invaders.forEach(inv => {
        if (!inv.alive) return;
        const colors = ['#f0f', '#ff0', '#0ff'];
        ctx.fillStyle = colors[inv.type];
        ctx.fillRect(inv.x, inv.y, inv.width, inv.height);
    });
}

// =====================
// UI
// =====================
function updateUI() {
    document.getElementById('score').textContent = gameState.score;
    document.getElementById('wave').textContent = gameState.wave;
    document.getElementById('healthFill').style.width =
        (gameState.player.health / gameState.player.maxHealth) * 100 + '%';
}

// =====================
// ゲームループ
// =====================
function gameLoop() {
    update();
    draw();
    requestAnimationFrame(gameLoop);
}

// =====================
// スタート
// =====================
startGame('normal');
gameLoop();
